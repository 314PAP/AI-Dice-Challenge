/**
 * üé≤ AI Dice Challenge - Main Application
 * Hlavn√≠ vstupn√≠ bod aplikace s maxim√°ln√≠m vyu≈æit√≠m npm knihoven
 */

// Import z√°kladn√≠ch knihoven
import { debounce, throttle } from 'lodash-es';
import { EventEmitter } from 'events';
import AOS from 'aos';
import 'aos/dist/aos.css';

// Import modul≈Ø aplikace
import { GameStateManager } from './core/GameStateManager.js';
import { UIManager } from './core/UIManager.js';
import { TemplateLoader } from './core/TemplateLoader.js';
import { EventManager } from './core/EventManager.js';

console.log('üé≤ AI Dice Challenge - Starting application...');

/**
 * Hlavn√≠ t≈ô√≠da aplikace
 */
class DiceGameApp {
    constructor() {
        this.gameState = new GameStateManager();
        this.uiManager = new UIManager();
        this.templateLoader = new TemplateLoader();
        this.eventManager = new EventManager();
        this.initialized = false;
    }

    /**
     * Inicializace aplikace
     */
    async initialize() {
        try {
            console.log('üöÄ Initializing application...');
            
            // Naƒçten√≠ ≈°ablon
            await this.loadTemplates();
            
            // Inicializace UI
            await this.initializeUI();
            
            // Nastaven√≠ event listener≈Ø
            this.setupEventListeners();
            
            // Inicializace animac√≠
            this.initializeAnimations();
            
            this.initialized = true;
            console.log('‚úÖ Application initialized successfully');
            
        } catch (error) {
            console.error('‚ùå Failed to initialize application:', error);
            this.handleInitializationError(error);
        }
    }

    /**
     * Naƒçten√≠ HTML ≈°ablon
     */
    async loadTemplates() {
        const templates = [
            { id: 'gameContent', file: '/src/templates/game-menu.html' },
            { id: 'gameMobileContent', file: '/src/templates/game-menu-mobile.html' },
            { id: 'chatPanel', file: '/src/templates/chat.html' },
            { id: 'chatPanelMobileContainer', file: '/src/templates/chat-mobile.html' },
            { id: 'gameControls', file: '/src/templates/game-controls.html' },
            { id: 'gameControlsMobile', file: '/src/templates/game-controls-mobile.html' }
        ];

        for (const template of templates) {
            try {
                const html = await this.templateLoader.load(template.file);
                const container = document.getElementById(template.id);
                if (container) {
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error(`Failed to load template ${template.file}:`, error);
            }
        }

        // Naƒçten√≠ mod√°l≈Ø
        await this.loadModals();
    }

    /**
     * Naƒçten√≠ mod√°ln√≠ch oken
     */
    async loadModals() {
        const modals = [
            '/src/templates/modals/rules-modal.html',
            '/src/templates/modals/hall-of-fame-modal.html',
            '/src/templates/modals/game-over-modal.html'
        ];

        const container = document.getElementById('modalsContainer') || document.body;
        
        for (const modal of modals) {
            try {
                const html = await this.templateLoader.load(modal);
                container.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                console.error(`Failed to load modal ${modal}:`, error);
            }
        }
    }

    /**
     * Inicializace UI
     */
    async initializeUI() {
        await this.uiManager.initialize();
    }

    /**
     * Nastaven√≠ event listener≈Ø
     */
    setupEventListeners() {
        // Glob√°ln√≠ event listenery
        this.setupGlobalEvents();
        
        // Hern√≠ event listenery
        this.setupGameEvents();
        
        // UI event listenery
        this.setupUIEvents();
    }

    /**
     * Nastaven√≠ glob√°ln√≠ch event listener≈Ø
     */
    setupGlobalEvents() {
        // Resize handler s throttle
        const resizeHandler = throttle(() => {
            this.handleResize();
        }, 100);
        
        window.addEventListener('resize', resizeHandler);
        
        // Error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            this.handleGlobalError(event.error);
        });
    }

    /**
     * Nastaven√≠ hern√≠ch event listener≈Ø
     */
    setupGameEvents() {
        // Start game
        document.addEventListener('click', (e) => {
            if (e.target.matches('#startGameBtn, #startGameBtnMobile')) {
                this.startGame();
            }
        });

        // Quit game
        document.addEventListener('click', (e) => {
            if (e.target.matches('#quitGameBtn, #quitGameBtnMobile')) {
                this.quitGame();
            }
        });

        // Hall of Fame
        document.addEventListener('click', (e) => {
            if (e.target.matches('#hallOfFameBtn, #hallOfFameBtnMobile')) {
                this.showHallOfFame();
            }
        });

        // Rules
        document.addEventListener('click', (e) => {
            if (e.target.matches('#rulesBtn, #rulesBtnMobile')) {
                this.showRules();
            }
        });
    }

    /**
     * Nastaven√≠ UI event listener≈Ø
     */
    setupUIEvents() {
        // Modal close handlers
        document.addEventListener('click', (e) => {
            if (e.target.matches('.modal-close, .modal-overlay')) {
                this.closeModal(e.target);
            }
        });

        // Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeTopModal();
            }
        });
    }

    /**
     * Inicializace animac√≠
     */
    initializeAnimations() {
        // AOS animace
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: false,
            mirror: true,
            anchorPlacement: 'top-bottom'
        });

        // Refresh AOS po naƒçten√≠ ≈°ablon
        setTimeout(() => {
            AOS.refresh();
        }, 100);
    }

    /**
     * Spu≈°tƒõn√≠ hry
     */
    async startGame() {
        try {
            console.log('üéÆ Starting game...');
            
            // Skryj menu, zobraz hern√≠ ovl√°d√°n√≠
            this.hideMenus();
            this.showGameControls();
            
            // Inicializuj hern√≠ stav
            await this.gameState.startGame();
            
            // Aktualizuj UI
            this.uiManager.updateGameDisplay();
            
        } catch (error) {
            console.error('‚ùå Failed to start game:', error);
        }
    }

    /**
     * Ukonƒçen√≠ hry
     */
    async quitGame() {
        try {
            console.log('üîö Quitting game...');
            
            // Skryj hern√≠ ovl√°d√°n√≠, zobraz menu
            this.hideGameControls();
            this.showMenus();
            
            // Reset hern√≠ho stavu
            await this.gameState.resetGame();
            
            // Aktualizuj UI
            this.uiManager.updateGameDisplay();
            
        } catch (error) {
            console.error('‚ùå Failed to quit game:', error);
        }
    }

    /**
     * Zobrazen√≠ Hall of Fame
     */
    showHallOfFame() {
        const modal = document.getElementById('hallOfFameModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    /**
     * Zobrazen√≠ pravidel
     */
    showRules() {
        const modal = document.getElementById('rulesModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    /**
     * Skryt√≠ menu
     */
    hideMenus() {
        const elements = [
            document.getElementById('gameContent'),
            document.getElementById('gameMobileContent')
        ];
        
        elements.forEach(el => {
            if (el) el.classList.add('hidden');
        });
    }

    /**
     * Zobrazen√≠ menu
     */
    showMenus() {
        const elements = [
            document.getElementById('gameContent'),
            document.getElementById('gameMobileContent')
        ];
        
        elements.forEach(el => {
            if (el) el.classList.remove('hidden');
        });
    }

    /**
     * Skryt√≠ hern√≠ch ovl√°d√°n√≠
     */
    hideGameControls() {
        const elements = [
            document.getElementById('gameControls'),
            document.getElementById('gameControlsMobile')
        ];
        
        elements.forEach(el => {
            if (el) el.classList.add('hidden');
        });
    }

    /**
     * Zobrazen√≠ hern√≠ch ovl√°d√°n√≠
     */
    showGameControls() {
        const elements = [
            document.getElementById('gameControls'),
            document.getElementById('gameControlsMobile')
        ];
        
        elements.forEach(el => {
            if (el) el.classList.remove('hidden');
        });
    }

    /**
     * Zav≈ôen√≠ mod√°ln√≠ho okna
     */
    closeModal(target) {
        const modal = target.closest('.modal-overlay');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * Zav≈ôen√≠ horn√≠ho mod√°ln√≠ho okna
     */
    closeTopModal() {
        const modals = document.querySelectorAll('.modal-overlay:not(.hidden)');
        if (modals.length > 0) {
            modals[modals.length - 1].classList.add('hidden');
        }
    }

    /**
     * Zpracov√°n√≠ resize ud√°lost√≠
     */
    handleResize() {
        // Refresh AOS p≈ôi zmƒõnƒõ velikosti okna
        AOS.refresh();
        
        // Aktualizuj UI layout
        this.uiManager.handleResize();
    }

    /**
     * Zpracov√°n√≠ chyb p≈ôi inicializaci
     */
    handleInitializationError(error) {
        console.error('Initialization error:', error);
        
        // Zobraz chybovou zpr√°vu u≈æivateli
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger position-fixed top-0 start-0 w-100 text-center';
        errorDiv.style.zIndex = '9999';
        errorDiv.innerHTML = `
            <h4>‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ aplikace</h4>
            <p>Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ hry. Zkuste obnovit str√°nku.</p>
            <button class="btn btn-primary" onclick="window.location.reload()">Obnovit str√°nku</button>
        `;
        
        document.body.appendChild(errorDiv);
    }

    /**
     * Zpracov√°n√≠ glob√°ln√≠ch chyb
     */
    handleGlobalError(error) {
        console.error('Global error:', error);
        // Zde m≈Ø≈æete implementovat reporting chyb
    }
}

// Inicializace aplikace po naƒçten√≠ DOM
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üé≤ DOM loaded, initializing application...');
    
    try {
        const app = new DiceGameApp();
        await app.initialize();
        
        // Zp≈ô√≠stupnƒõn√≠ pro debugging
        window.diceGame = app;
        
    } catch (error) {
        console.error('‚ùå Failed to initialize dice game:', error);
    }
});

export default DiceGameApp;
console.log('üîç Document ready state:', document.readyState);

// Import UI controlleru pro ≈ô√≠zen√≠ cel√© aplikace
import { setupUI } from './js/ui/uiController.js';
import { initializeGame } from './js/game/gameController.js';
import { initializeChat } from './js/ui/enhancedChatController.js';
import { setupOptimizedEvents } from './js/utils/optimizedEvents.js';
import { initializeAllEventListeners } from './js/utils/eventInitializer.js';
import { tryCatchWithLogging } from './js/utils/errorHandling.js';
import { eventBus, GAME_EVENTS } from './js/utils/eventBus.js';
import enhancedGameStarter from './js/game/enhancedGameStarter.js';
import { whenDOMReady } from './js/utils/domReadyObserver.js';

/**
 * Inicializace aplikace se spolehliv√Ωm naƒç√≠t√°n√≠m DOM
 * Vyu≈æ√≠v√° observer pro zaji≈°tƒõn√≠, ≈æe v≈°echny pot≈ôebn√© elementy jsou dostupn√©
 */
console.log('üîÑ Inicializace aplikace se spolehliv√Ωm naƒç√≠t√°n√≠m...');

// Pou≈æijeme whenDOMReady nam√≠sto standardn√≠ho DOMContentLoaded event listeneru
whenDOMReady(() => {
    console.log('‚úÖ DOM a v≈°echny kl√≠ƒçov√© elementy jsou naƒçteny, inicializuji aplikaci...');
    
    try {
        // Pou≈æ√≠v√°me bezpeƒçnou funkci pro inicializaci s error handlingem
        const initializeApp = tryCatchWithLogging(() => {
            console.log('üöÄ Initializing UI and Game Controllers...');
            
            // Inicializuj UI
            setupUI();
            
            // Inicializace event syst√©mu
            setupOptimizedEvents();
            
            // Registrace glob√°ln√≠ho event listeneru pro debugging
            eventBus.on(GAME_EVENTS.GAME_STARTED, data => {
                console.log('üéÆ Game started with settings:', data);
            });
            
            // Inicializuj chat
            const chatController = initializeChat();
            
            // Inicializuj game controller
            initializeGame();
            
            // Zp≈ô√≠stupni chat glob√°lnƒõ pro kompatibilitu - opravena signatura
            window.addChatMessage = (sender, message) => chatController.addMessage(sender, message);
            window.chatController = chatController;
            
            // Zp≈ô√≠stupni hern√≠ funkce glob√°lnƒõ pro kompatibilitu
            window.selectDie = async (index) => {
                const { selectDie } = await import('./js/game/controllers/turnActionsController.js');
                selectDie(index);
            };
            
            window.bankSelectedDice = async () => {
                const { bankSelectedDice } = await import('./js/game/controllers/turnActionsController.js');
                bankSelectedDice();
            };
            
            // Explicitnƒõ nastav√≠me v≈°echny event listenery pomoc√≠ nov√©ho inicializ√°toru
            console.log('üéÆ Inicializuji v≈°echny event listenery pomoc√≠ nov√©ho syst√©mu...');
            initializeAllEventListeners();
            
            // Vylep≈°en√© listenery pro start hry
            enhancedGameStarter.attachGameStartListeners();
            
            // Relogujeme √∫spƒõ≈°nost event listener≈Ø
            setTimeout(() => {
                console.log('üîç Kontrola event listener≈Ø po inicializaci:');
                
                ['startGameBtn', 'rollBtn', 'bankBtn', 'endTurnBtn', 'chatInput'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        console.log(`‚úÖ Element ${id} je dostupn√Ω`);
                    } else {
                        console.error(`‚ùå Element ${id} nen√≠ dostupn√Ω!`);
                    }
                });
            }, 500);
            
            console.log('‚úÖ AI Kostkov√° V√Ωzva ready!');
            
            return true;
        }, false, 'Application Initialization');
        
        // Spust√≠me inicializaci
        initializeApp();
        console.log('üîç Global objects:', {
            gameController: !!window.gameController,
            addChatMessage: !!window.addChatMessage
        });
        
    } catch (error) {
        console.error('‚ùå Critical error during initialization:', error);
        console.error('‚ùå Error stack:', error.stack);
        
        // Fallback - z√°kladn√≠ funkcionalita bez modul≈Ø
        setupEmergencyFallback();
    }
});

/**
 * Emergency fallback pro p≈ô√≠pad selh√°n√≠ modul√°rn√≠ho syst√©mu
 */
function setupEmergencyFallback() {
    console.log('üîß Setting up emergency fallback...');
    
    // Z√°kladn√≠ start game funkcionalita
    const startBtn = document.getElementById('startGameBtn');
    const hallBtn = document.getElementById('hallOfFameBtn');
    const gameControls = document.getElementById('gameControls');
    const targetScoreSetup = document.getElementById('targetScoreSetup');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendMessageBtn');
    
    console.log('üîß Found elements:', {
        startBtn: !!startBtn,
        hallBtn: !!hallBtn,
        gameControls: !!gameControls,
        targetScoreSetup: !!targetScoreSetup,
        chatInput: !!chatInput,
        sendBtn: !!sendBtn
    });
    
    if (startBtn) {
        console.log('üîß Adding start button listener...');
        startBtn.addEventListener('click', () => {
            console.log('üöÄ Emergency start game');
            alert('Start Game button clicked! (Emergency mode)');
            
            if (targetScoreSetup && gameControls) {
                targetScoreSetup.style.display = 'none';
                gameControls.classList.remove('hidden');
            }
        });
    }
    
    if (hallBtn) {
        console.log('üîß Adding hall of fame button listener...');
        hallBtn.addEventListener('click', () => {
            console.log('üèÜ Emergency hall of fame');
            alert('Hall of Fame button clicked! (Emergency mode)');
        });
    }
    
    if (chatInput && sendBtn) {
        console.log('üîß Adding chat listeners...');
        const sendMessage = () => {
            const message = chatInput.value.trim();
            if (message) {
                console.log('üí¨ Emergency chat:', message);
                alert(`Chat message: ${message} (Emergency mode)`);
                chatInput.value = '';
            }
        };
        
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
    
    // P≈ôidej z√°kladn√≠ chat zpr√°vu
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = '<div style="color: #ff6600; padding: 10px;">üîß Emergency mode active - modular system failed to load</div>';
    }
    
    console.log('‚úÖ Emergency fallback setup complete');
    
    // Expose emergency fallback functions globally
    window.emergencyFallback = true;
    window.addChatMessage = (sender, message) => {
        console.log(`üí¨ Emergency chat from ${sender}: ${message}`);
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const messageDiv = document.createElement('div');
            messageDiv.style.color = '#39ff14';
            messageDiv.style.padding = '5px';
            messageDiv.textContent = `${sender}: ${message}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };
}

/**
 * Fallback pro celkov√© selh√°n√≠
 */
window.addEventListener('error', (e) => {
    console.error('üö® Global error caught:', e.error);
    if (!window.emergencyFallback) {
        setupEmergencyFallback();
    }
});

console.log('üîö main.js loaded completely');
